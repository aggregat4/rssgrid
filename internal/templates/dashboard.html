<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RSSGrid</title>
    <link rel="stylesheet" href="/static/styles.css">
</head>
<body>
    <header class="header">
        <h1>RSSGrid</h1>
        <nav class="nav">
            <a href="/">Dashboard</a>
            <a href="/settings">Settings</a>
            <form action="/logout" method="POST" style="display: inline;">
                <button type="submit" class="btn btn-secondary">Logout</button>
            </form>
        </nav>
    </header>

    <main class="container">
        <div class="grid">
            {{range .Feeds}}
            <div class="widget">
                <div class="widget-header">
                    <h2 class="widget-title">{{.Feed.Title}}</h2>
                    <form action="/feeds/{{.Feed.ID}}/seen" method="POST">
                        <button type="submit" class="btn btn-secondary">Mark All as Read</button>
                    </form>
                </div>
                <ul class="post-list">
                    {{range .Posts}}
                    <li class="post-item">
                        <a href="#" role="button" class="post-link {{if .Seen}}seen{{end}}" data-post-id="{{.ID}}" data-post-title="{{.Title}}">
                            {{.Title}}
                        </a>
                    </li>
                    {{end}}
                </ul>
            </div>
            {{end}}
        </div>
    </main>

    <!-- Post Detail Dialog -->
    <dialog id="postDialog" class="post-dialog-modal">
        <div class="post-dialog-content">
            <div class="post-dialog-header">
                <h2 id="dialogTitle" class="post-title"></h2>
                <div class="post-meta">
                    <span id="dialogDate" class="post-date"></span>
                </div>
                <div class="post-actions">
                    <a id="dialogOriginalLink" href="#" target="_blank" class="btn btn-primary">View Original</a>
                    <button class="btn btn-secondary" onclick="closePostDialog()">Close</button>
                </div>
            </div>
            <div id="dialogContent" class="post-content">
                <p>Loading...</p>
            </div>
        </div>
    </dialog>

    <script>
        let lastOpenedPostButton = null;

        // Mark post as seen when clicked
        document.addEventListener('click', function(e) {
            if (e.target.matches('.post-link')) {
                e.preventDefault(); // Prevent navigation since href="#"
                
                const postId = e.target.dataset.postId;
                const postTitle = e.target.dataset.postTitle;
                if (postId) {
                    // Mark as seen
                    fetch(`/posts/${postId}/seen`, {
                        method: 'POST',
                    }).catch(console.error);
                    
                    // Remember the button for later styling
                    lastOpenedPostButton = e.target;
                    
                    // Open post dialog
                    openPostDialog(postId, postTitle);
                }
            }
        });

        // Listen for dialog close event (triggered by Escape, clicking outside, or close button)
        document.getElementById('postDialog').addEventListener('close', function() {
            // Mark the last opened post as seen in the UI
            if (lastOpenedPostButton) {
                lastOpenedPostButton.classList.add('seen');
                lastOpenedPostButton = null;
            }
        });

        // Handle clicking outside the dialog to dismiss it
        document.getElementById('postDialog').addEventListener('click', function(e) {
            if (e.target === this) {
                this.close();
            }
        });

        function openPostDialog(postId, postTitle) {
            const dialog = document.getElementById('postDialog');
            const titleElement = document.getElementById('dialogTitle');
            const contentElement = document.getElementById('dialogContent');
            const dateElement = document.getElementById('dialogDate');
            const originalLinkElement = document.getElementById('dialogOriginalLink');
            
            // Set initial content
            titleElement.textContent = postTitle;
            contentElement.innerHTML = '<p>Loading...</p>';
            dateElement.textContent = '';
            originalLinkElement.href = '#';
            
            // Show dialog
            dialog.showModal();
            
            // Fetch post details
            fetch(`/posts/${postId}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Failed to fetch post');
                    }
                    return response.text();
                })
                .then(html => {
                    // Create a temporary div to parse the HTML
                    const tempDiv = document.createElement('div');
                    tempDiv.innerHTML = html;
                    
                    // Extract content from the parsed HTML
                    const postContent = tempDiv.querySelector('.post-content');
                    const postDate = tempDiv.querySelector('.post-date');
                    const originalLink = tempDiv.querySelector('a[target="_blank"]');
                    
                    if (postContent) {
                        contentElement.innerHTML = postContent.innerHTML;
                    }
                    
                    if (postDate) {
                        dateElement.textContent = postDate.textContent;
                    }
                    
                    if (originalLink) {
                        originalLinkElement.href = originalLink.href;
                    }
                })
                .catch(error => {
                    console.error('Error fetching post:', error);
                    contentElement.innerHTML = '<p>Error loading post content.</p>';
                });
        }

        function closePostDialog() {
            const dialog = document.getElementById('postDialog');
            dialog.close();
        }
    </script>
</body>
</html> 